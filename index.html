<!-- index.html - Your Public Frontend -->
<!-- Upload this file to your GitHub repository. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Digital Museum of Pathology Specimens</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 10px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2em; color: #2c3e50; margin-bottom: 5px; }
        .header p { font-size: 1.1em; color: #7f8c8d; margin-top: 0; }
        .main-container { width: 100%; max-width: 900px; margin: 10px auto; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 15px; box-sizing: border-box; }
        #specimen-list-container { text-align: left; }
        #specimen-viewer-container { display: none; }
        #search-bar { width: 100%; padding: 12px; font-size: 1em; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        .organ-system-category h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 30px; }
        .specimen-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .specimen-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .specimen-item:hover { background-color: #ecf0f1; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #spinner-container { position: relative; width: 100%; margin: 20px auto; user-select: none; border-radius: 8px; overflow: hidden; border: 1px solid #e1e1e1; touch-action: pan-y; cursor: grab; }
        #spinner-image-div { width: 100%; aspect-ratio: 3 / 4; background-repeat: no-repeat; background-position: center; background-size: 100%; transition: background-size 0.2s ease-out; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; font-size: 1.2em; color: #333; z-index: 10; display: none; }
        #fullscreen-btn { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); border: none; border-radius: 5px; cursor: pointer; z-index: 5; padding: 6px; }
        #fullscreen-btn svg { width: 100%; height: 100%; fill: white; }
        #fullscreen-enter-icon { display: block; }
        #fullscreen-exit-icon { display: none; }
        #back-button { margin-bottom: 20px; background: #7f8c8d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .notes-section { text-align: left; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eeeeee; }
        .notes-section h3 { color: #34495e; }
        .notes-section p, .notes-section ul { font-size: 1em; line-height: 1.6; color: #555; }

        /* Fit-to-height on landscape screens */
        @media (orientation: landscape) {
            #spinner-image-div {
                height: 60vh; /* Adjust this value as needed */
                width: auto;
                aspect-ratio: 3 / 4;
                margin: auto;
            }
        }
        
        /* Pseudo-fullscreen mode for iOS */
        .fullscreen-mode {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            z-index: 9999;
            padding: 0 !important;
            border-radius: 0 !important;
        }
        .fullscreen-mode #spinner-image-div {
            height: 100vh;
            width: auto;
            margin: auto;
        }
        .fullscreen-mode #back-button, .fullscreen-mode header, .fullscreen-mode .notes-section {
            display: none;
        }

    </style>
</head>
<body>

    <div id="specimen-list-container">
        <header class="header">
            <h1>Digital Museum of Pathology Specimens</h1>
            <p>An interactive archive for medical education.</p>
        </header>
        <div class="main-container">
            <input type="text" id="search-bar" placeholder="Search by title, description, or keyword...">
            <div id="specimen-list">
                <p>Loading specimens...</p>
            </div>
        </div>
    </div>

    <div id="specimen-viewer-container" class="main-container">
        <button id="back-button">&larr; Back to Archive</button>
        <header>
            <h1 id="viewer-title"></h1>
        </header>
        <div id="spinner-container">
            <div id="spinner-image-div" role="img" aria-label="360 specimen view"></div>
            <div id="loading-overlay">Loading...</div>
            <button id="fullscreen-btn" aria-label="Toggle Fullscreen">
                <svg id="fullscreen-enter-icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                <svg id="fullscreen-exit-icon" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
            </button>
        </div>
        <section class="notes-section">
            <div id="viewer-notes"></div>
        </section>
    </div>

    <!-- Hidden container for preloading images into the DOM -->
    <div id="preload-container" style="display: none;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD3XmS2pl4mBZ8Ov3XjRg7kIi8VtcTwq7E",
            authDomain: "muse-4f192.firebaseapp.com",
            projectId: "muse-4f192",
            storageBucket: "muse-4f192.firebasestorage.app", // The DEFAULT bucket
            messagingSenderId: "587629353476",
            appId: "1:587629353476:web:08063709cc60e92ea57351",
            measurementId: "G-NMDD20TYVB"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const storage = firebase.storage(app, "gs://muse-4f192-asia");

        const listContainer = document.getElementById('specimen-list-container');
        const viewerContainer = document.getElementById('specimen-viewer-container');
        const specimenListDiv = document.getElementById('specimen-list');
        const spinnerDiv = document.getElementById('spinner-image-div');
        const spinnerContainer = document.getElementById('spinner-container');
        const searchBar = document.getElementById('search-bar');
        const loadingOverlay = document.getElementById('loading-overlay');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const enterIcon = document.getElementById('fullscreen-enter-icon');
        const exitIcon = document.getElementById('fullscreen-exit-icon');
        
        let allSpecimens = []; 
        let specimensData = {};
        let currentImageUrls = [];
        let currentFrame = 0;
        let isDragging = false;
        let lastX = 0, lastY = 0, panX = 50, panY = 50, zoomLevel = 1;
        let initialPinchDistance = 0, initialZoomLevel = 1;

        async function loadSpecimenList() {
            try {
                const snapshot = await db.collection("specimens").orderBy("createdAt", "desc").get();
                allSpecimens = [];
                specimensData = {};
                if (snapshot.empty) {
                    renderSpecimens([]);
                    return;
                }
                snapshot.forEach(doc => {
                    const specimen = { id: doc.id, ...doc.data() };
                    allSpecimens.push(specimen);
                    specimensData[doc.id] = specimen;
                });
                renderSpecimens(allSpecimens);
            } catch (error) {
                console.error("Error loading specimens:", error);
                specimenListDiv.innerHTML = '<p>Error loading specimens. Please check your Firestore security rules.</p>';
            }
        }

        function renderSpecimens(specimensToRender) {
            specimenListDiv.innerHTML = '';
            if (specimensToRender.length === 0) {
                specimenListDiv.innerHTML = '<p>No matching specimens found.</p>';
                return;
            }

            const groupedBySystem = specimensToRender.reduce((acc, specimen) => {
                const system = specimen.organSystem || 'Other';
                if (!acc[system]) { acc[system] = []; }
                acc[system].push(specimen);
                return acc;
            }, {});

            const sortedSystems = Object.keys(groupedBySystem).sort();

            for (const system of sortedSystems) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'organ-system-category';
                categoryDiv.innerHTML = `<h2>${system}</h2>`;
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'specimen-grid';

                groupedBySystem[system].forEach(specimen => {
                    const item = document.createElement('div');
                    item.className = 'specimen-item';
                    item.textContent = specimen.title;
                    item.onclick = () => showViewer(specimen.id);
                    gridDiv.appendChild(item);
                });
                
                categoryDiv.appendChild(gridDiv);
                specimenListDiv.appendChild(categoryDiv);
            }
        }
        
        function filterSpecimens() {
            const query = searchBar.value.toLowerCase();
            const filtered = allSpecimens.filter(s => 
                s.title.toLowerCase().includes(query) ||
                s.description.toLowerCase().includes(query) ||
                s.keywords.some(k => k.toLowerCase().includes(query))
            );
            renderSpecimens(filtered);
        }

        async function showViewer(specimenId) {
            const specimen = specimensData[specimenId];
            if (!specimen) return;

            document.getElementById('viewer-title').textContent = specimen.title;
            const notesDiv = document.getElementById('viewer-notes');
            notesDiv.innerHTML = `
                <h3>Description</h3>
                <p>${specimen.description.replace(/\n/g, '<br>')}</p>
                <h3>Keywords</h3>
                <p><em>${specimen.keywords.join(', ')}</em></p>
            `;

            currentImageUrls = specimen.imageUrls;
            
            listContainer.style.display = 'none';
            viewerContainer.style.display = 'block';

            if (currentImageUrls.length > 0) {
                loadingOverlay.style.display = 'flex';
                await preloadImages(currentImageUrls); // Wait for images to load
                loadingOverlay.style.display = 'none';
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[0]})`;
            }
        }

        function showList() {
            listContainer.style.display = 'block';
            viewerContainer.style.display = 'none';
            resetZoomAndPan();
        }

        function preloadImages(urls) {
            const preloadContainer = document.getElementById('preload-container');
            preloadContainer.innerHTML = ''; // Clear previous images
            const promises = urls.map(src => {
                return new Promise((resolve, reject) => {
                    const img = document.createElement('img');
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = src;
                    preloadContainer.appendChild(img);
                });
            });
            return Promise.all(promises);
        }

        function updateImage(newX) {
            const sensitivity = 10;
            if (Math.abs(newX - lastX) > sensitivity) {
                currentFrame += (newX > lastX) ? 1 : -1;
                if (currentFrame >= currentImageUrls.length) currentFrame = 0;
                if (currentFrame < 0) currentFrame = currentImageUrls.length - 1;
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[currentFrame]})`;
                lastX = newX;
            }
        }
        
        function panImage(clientX, clientY) {
            const rect = spinnerContainer.getBoundingClientRect();
            const newPanX = panX + (clientX - lastX) / rect.width * 100;
            const newPanY = panY + (clientY - lastY) / rect.height * 100;
            const maxPan = 100 - (50 / (zoomLevel / 2));
            const minPan = 100 - maxPan;
            panX = Math.max(minPan, Math.min(maxPan, newPanX));
            panY = Math.max(minPan, Math.min(maxPan, newPanY));
            spinnerDiv.style.backgroundPosition = `${panX}% ${panY}%`;
            lastX = clientX;
            lastY = clientY;
        }

        function updateZoom(newZoomLevel) {
            const minZoom = 1.0, maxZoom = 4.0;
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, newZoomLevel));
            spinnerDiv.style.backgroundSize = `${zoomLevel * 100}%`;
            if (zoomLevel <= 1) resetPan();
        }

        function resetPan() {
            panX = 50; panY = 50;
            spinnerDiv.style.backgroundPosition = 'center';
        }
        
        function resetZoomAndPan() {
            zoomLevel = 1.0;
            spinnerDiv.style.backgroundSize = '100%';
            resetPan();
        }

        function onDragStart(clientX, clientY) {
            isDragging = true;
            lastX = clientX; lastY = clientY;
            spinnerContainer.style.cursor = (zoomLevel > 1) ? 'move' : 'grabbing';
        }
        function onDragMove(clientX, clientY) {
            if (!isDragging) return;
            if (zoomLevel > 1) { panImage(clientX, clientY); } 
            else { updateImage(clientX); }
        }
        function onDragEnd() {
            isDragging = false;
            spinnerContainer.style.cursor = 'grab';
        }

        function getPinchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function toggleFullScreen() {
            const elem = viewerContainer;
            const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement || viewerContainer.classList.contains('fullscreen-mode');

            if (!isFullScreen) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else { // Fallback for iOS
                    viewerContainer.classList.add('fullscreen-mode');
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else { // Fallback for iOS
                    viewerContainer.classList.remove('fullscreen-mode');
                }
            }
        }
        
        function updateFullscreenIcon() {
            const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement || viewerContainer.classList.contains('fullscreen-mode');
            enterIcon.style.display = isFullScreen ? 'none' : 'block';
            exitIcon.style.display = isFullScreen ? 'block' : 'none';
        }

        document.addEventListener('fullscreenchange', updateFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);


        document.getElementById('back-button').addEventListener('click', showList);
        searchBar.addEventListener('keyup', filterSpecimens);
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        
        spinnerContainer.addEventListener('wheel', e => {
            e.preventDefault();
            updateZoom(zoomLevel - e.deltaY * 0.01);
        });
        
        spinnerContainer.addEventListener('mousedown', e => onDragStart(e.clientX, e.clientY));
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('mousemove', e => onDragMove(e.clientX, e.clientY));
        
        spinnerContainer.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                onDragStart(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                initialPinchDistance = getPinchDistance(e.touches);
                initialZoomLevel = zoomLevel;
            }
        }, { passive: true });

        window.addEventListener('touchend', e => {
            if (e.touches.length < 2) {
                onDragEnd();
            }
        });

        window.addEventListener('touchmove', e => {
            if (e.touches.length === 1) {
                onDragMove(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                const newPinchDistance = getPinchDistance(e.touches);
                if (initialPinchDistance > 0) {
                    const pinchRatio = newPinchDistance / initialPinchDistance;
                    updateZoom(initialZoomLevel * pinchRatio);
                }
            }
        });
        
        document.addEventListener('gesturestart', e => e.preventDefault());
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) { e.preventDefault(); }
            lastTouchEnd = now;
        }, false);

        loadSpecimenList();
    </script>
</body>
</html>
