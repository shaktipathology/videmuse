<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to properly lock page zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Museum of Pathology Specimens</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --header-color: #2c3e50;
            --subheader-color: #7f8c8d;
            --border-color: #e0e6ed;
            --hover-bg-color: #ecf0f1;
            --button-bg-color: #7f8c8d;
            --button-border-color: #7f8c8d;
            --accent-color: #3498db;
        }

        body.dark-theme {
            --bg-color: #121212;
            --card-bg-color: #1c1c1e;
            --text-color: #e0e0e0;
            --header-color: #ffffff;
            --subheader-color: #a0a0a0;
            --border-color: #383838;
            --hover-bg-color: #3a3a3a;
            --button-bg-color: #333;
            --button-border-color: #555;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        #theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1002;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
        }
        .sun-icon { display: none; }
        body.dark-theme .sun-icon { display: block; }
        body.dark-theme .moon-icon { display: none; }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2em; color: var(--header-color); margin-bottom: 5px; }
        .header p { font-size: 1.1em; color: var(--subheader-color); margin-top: 0; }
        .main-container { width: 100%; max-width: 1200px; margin: 10px auto; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 25px; box-sizing: border-box; }
        #specimen-viewer-container { display: none; }
        #search-bar { width: 100%; padding: 12px; font-size: 1em; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        
        /* --- Styles for the redesigned specimen list --- */
        .organ-system-category h2 {
            color: var(--header-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 30px;
            font-size: 1.4em; /* Made smaller as requested */
        }
        .specimen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }
        .specimen-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            aspect-ratio: 3 / 4;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 12px;
            background-size: cover;
            background-position: center;
            color: white;
        }
        .specimen-item:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .specimen-info { z-index: 2; }
        .specimen-title {
            font-size: 1.15em; /* Larger title for specimen */
            font-weight: 700;
            margin: 4px 0 0 0;
            line-height: 1.3;
        }
        .specimen-organ-tag {
            font-size: 0.75em; /* Smaller tag for organ system */
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        #spinner-container {
            position: relative;
            width: 100%;
            margin: 20px auto;
            user-select: none;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            touch-action: none; /* Disables browser default touch actions like scroll */
            cursor: grab;
        }
        #spinner-image-div {
            width: 100%;
            aspect-ratio: 4 / 3;
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100%;
            transition: background-size 0.1s ease-out;
        }
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2em; color: #333; z-index: 10; display: none;
        }
        body.dark-theme #loading-overlay { background: rgba(0, 0, 0, 0.8); color: #f1f1f1; }
        
        #back-button {
            margin-bottom: 20px; background: var(--button-bg-color);
            border: 1px solid var(--button-border-color); color: white;
            padding: 10px 15px; border-radius: 4px; cursor: pointer;
        }
        .notes-section {
            text-align: left; margin-top: 25px; padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* --- Edge-to-edge viewer styles --- */
        body.viewer-active { overflow: hidden; }
        body.viewer-active #specimen-viewer-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            max-width: none; background: var(--bg-color); z-index: 1000;
            padding: 0; border-radius: 0; display: flex;
            flex-direction: column; /* Mobile-first default */
        }
        body.viewer-active #spinner-container {
             flex-grow: 1; width: 100%; height: auto;
             border: none; border-radius: 0; margin: 0;
        }
        body.viewer-active #spinner-image-div {
            width: 100%; height: 100%; aspect-ratio: unset;
            background-size: contain;
        }
        body.viewer-active #back-button {
            position: absolute; top: 20px; left: 20px; z-index: 1002; /* Ensure it's on top */
        }
        body.viewer-active #viewer-info-panel {
            display: block;
            position: absolute; bottom: 0; left: 0; right: 0;
            max-height: 35vh; overflow-y: auto;
            background: linear-gradient(to top, var(--card-bg-color) 80%, transparent);
            padding: 50px 20px 20px 20px; text-align: left; z-index: 1001;
        }

        /* Hides the main list content when the viewer is open */
        body.viewer-active #specimen-list-container {
            display: none;
        }

        /* Widescreen layout adjustments */
        @media (min-width: 1024px) and (orientation: landscape) {
            body.viewer-active #specimen-viewer-container {
                flex-direction: row;
            }
            body.viewer-active #spinner-container {
                width: auto; /* Let flexbox decide width */
                height: 100vh;
            }
            body.viewer-active #viewer-info-panel {
                position: relative;
                flex-shrink: 0;
                width: 380px; /* Wider panel for more text */
                height: 100vh;
                max-height: 100vh;
                background: var(--card-bg-color);
                padding: 70px 30px 30px 30px; /* More padding */
                box-shadow: -4px 0 20px rgba(0,0,0,0.1);
                z-index: 1001;
            }
            body.dark-theme body.viewer-active #viewer-info-panel {
                box-shadow: -4px 0 20px rgba(0,0,0,0.4);
            }
        }

        #viewer-info-title { font-size: 1.5em; color: var(--header-color); }
        #viewer-info-description { line-height: 1.6; color: var(--text-color); }
        .notes-section { display: none; } /* Hide the old notes section */

    </style>
</head>
<body>

    <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24"><path d="M12 9c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm0 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm8-4h-2.07c-.33-1.2-.86-2.32-1.57-3.3l1.45-1.45c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.45 1.45C14.32 3.86 13.2 3.33 12 3.07V1c0-.55-.45-1-1-1s-1 .45-1 1v2.07c-1.2.33-2.32.86-3.3 1.57l-1.45-1.45c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.45 1.45c-.71.98-1.24 2.1-1.57 3.3H1c-.55 0-1 .45-1 1s.45 1 1 1h2.07c.33 1.2.86 2.32 1.57 3.3l-1.45 1.45c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.45-1.45c.98.71 2.1 1.24 3.3 1.57V23c0 .55.45 1 1 1s1-.45 1-1v-2.07c1.2-.33 2.32-.86 3.3-1.57l1.45 1.45c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.45-1.45c.71-.98 1.24-2.1 1.57-3.3H23c.55 0 1-.45 1-1s-.45-1-1-1zm-8 8c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-2.27-1.5-3.82-3.96-3.82-6.81 0-2.64 1.39-4.96 3.48-6.33-.31-.03-.62-.05-.94-.05z"/></svg>
    </button>

    <div id="specimen-list-container">
        <header class="header">
            <h1>Digital Museum of Pathology Specimens</h1>
            <p>An interactive archive for medical education.</p>
        </header>
        <div class="main-container">
            <input type="text" id="search-bar" placeholder="Search by title, description, or keyword...">
            <div id="specimen-list">
                <p>Loading specimens...</p>
            </div>
        </div>
    </div>

    <div id="specimen-viewer-container">
        <button id="back-button">&larr; Back</button>
        <div id="spinner-container">
            <div id="spinner-image-div" role="img" aria-label="360 specimen view"></div>
            <div id="loading-overlay">Loading...</div>
        </div>
        <div id="viewer-info-panel">
            <h2 id="viewer-info-title"></h2>
            <p id="viewer-info-description"></p>
        </div>
    </div>

    <div id="preload-container" style="display: none;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD3XmS2pl4mBZ8Ov3XjRg7kIi8VtcTwq7E",
            authDomain: "muse-4f192.firebaseapp.com",
            projectId: "muse-4f192",
            storageBucket: "muse-4f192.appspot.com",
            messagingSenderId: "587629353476",
            appId: "1:587629353476:web:08063709cc60e92ea57351",
            measurementId: "G-NMDD20TYVB"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();

        const viewerContainer = document.getElementById('specimen-viewer-container');
        const specimenListDiv = document.getElementById('specimen-list');
        const spinnerDiv = document.getElementById('spinner-image-div');
        const spinnerContainer = document.getElementById('spinner-container');
        const searchBar = document.getElementById('search-bar');
        const loadingOverlay = document.getElementById('loading-overlay');
        const themeToggle = document.getElementById('theme-toggle');

        let allSpecimens = [];
        let specimensData = {};
        let currentImageUrls = [];
        let currentFrame = 0;
        let isDragging = false;
        let lastX = 0, lastY = 0;
        let panX = 50, panY = 50, zoomLevel = 1;
        let initialPinchDistance = 0, initialZoomLevel = 1;

        // --- Theme Toggler ---
        function applyTheme(theme) {
            document.body.classList.toggle('dark-theme', theme === 'dark');
        }
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        });
        applyTheme(localStorage.getItem('theme') || 'light');

        // --- Data Loading and Rendering ---
        async function loadSpecimenList() {
            try {
                const snapshot = await db.collection("specimens").orderBy("createdAt", "desc").get();
                allSpecimens = [];
                specimensData = {};
                snapshot.forEach(doc => {
                    const specimen = { id: doc.id, ...doc.data() };
                    allSpecimens.push(specimen);
                    specimensData[doc.id] = specimen;
                });
                renderSpecimens(allSpecimens);
            } catch (error) {
                console.error("Error loading specimens:", error);
                specimenListDiv.innerHTML = '<p>Error loading specimens. Please try again later.</p>';
            }
        }

        function renderSpecimens(specimensToRender) {
            specimenListDiv.innerHTML = '';
            if (specimensToRender.length === 0) {
                specimenListDiv.innerHTML = '<p>No matching specimens found.</p>';
                return;
            }

            const groupedBySystem = specimensToRender.reduce((acc, specimen) => {
                const system = specimen.organSystem || 'Other';
                if (!acc[system]) { acc[system] = []; }
                acc[system].push(specimen);
                return acc;
            }, {});

            Object.keys(groupedBySystem).sort().forEach(system => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'organ-system-category';
                categoryDiv.innerHTML = `<h2>${system}</h2>`;
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'specimen-grid';

                groupedBySystem[system].forEach(specimen => {
                    const item = document.createElement('div');
                    item.className = 'specimen-item';
                    item.onclick = () => showViewer(specimen.id);

                    if (specimen.imageUrls && specimen.imageUrls.length > 0) {
                        item.style.backgroundImage = `linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 50%), url(${specimen.imageUrls[0]})`;
                    } else {
                        item.style.backgroundColor = 'var(--hover-bg-color)';
                    }
                    
                    item.innerHTML = `
                        <div class="specimen-info">
                            <h3 class="specimen-title">${specimen.title}</h3>
                        </div>
                    `;
                    gridDiv.appendChild(item);
                });
                
                categoryDiv.appendChild(gridDiv);
                specimenListDiv.appendChild(categoryDiv);
            });
        }
        
        function filterSpecimens() {
            const query = searchBar.value.toLowerCase();
            const filtered = allSpecimens.filter(s => 
                s.title.toLowerCase().includes(query) ||
                s.description.toLowerCase().includes(query) ||
                (s.keywords && s.keywords.some(k => k.toLowerCase().includes(query)))
            );
            renderSpecimens(filtered);
        }

        // --- Viewer Logic ---
        async function showViewer(specimenId) {
            const specimen = specimensData[specimenId];
            if (!specimen) return;

            document.getElementById('viewer-info-title').textContent = specimen.title;
            document.getElementById('viewer-info-description').innerHTML = specimen.description.replace(/\n/g, '<br>');

            currentImageUrls = specimen.imageUrls || [];
            
            document.body.classList.add('viewer-active');
            viewerContainer.style.display = 'flex';
            resetZoomAndPan(); // Reset state for the new specimen

            if (currentImageUrls.length > 0) {
                loadingOverlay.style.display = 'flex';
                await preloadImages(currentImageUrls);
                loadingOverlay.style.display = 'none';
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[0]})`;
            } else {
                 spinnerDiv.style.backgroundImage = 'none';
            }
        }

        function showList() {
            document.body.classList.remove('viewer-active');
            viewerContainer.style.display = 'none';
            resetZoomAndPan();
        }

        function preloadImages(urls) {
            const preloadContainer = document.getElementById('preload-container');
            preloadContainer.innerHTML = '';
            return Promise.all(urls.map(src => new Promise((resolve) => {
                const img = document.createElement('img');
                img.onload = img.onerror = resolve; // Resolve even on error to not block UI
                img.src = src;
                preloadContainer.appendChild(img);
            })));
        }

        // --- IMPROVED Zoom, Pan, and Rotate Logic ---
        function updateImage(newX) {
            const sensitivity = 8; // Lower is more sensitive
            if (Math.abs(newX - lastX) > sensitivity) {
                currentFrame += (newX > lastX) ? -1 : 1;
                if (currentFrame >= currentImageUrls.length) currentFrame = 0;
                if (currentFrame < 0) currentFrame = currentImageUrls.length - 1;
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[currentFrame]})`;
                lastX = newX;
            }
        }
        
        function panImage(clientX, clientY) {
            const rect = spinnerContainer.getBoundingClientRect();
            const deltaX = ((clientX - lastX) / rect.width) * 100;
            const deltaY = ((clientY - lastY) / rect.height) * 100;
            
            const minPan = 50 / zoomLevel;
            const maxPan = 100 - minPan;

            panX = Math.max(minPan, Math.min(maxPan, panX + deltaX));
            panY = Math.max(minPan, Math.min(maxPan, panY + deltaY));
            
            spinnerDiv.style.backgroundPosition = `${panX}% ${panY}%`;
            lastX = clientX;
            lastY = clientY;
        }

        function updateZoom(newZoomLevel) {
            const minZoom = 1.0, maxZoom = 5.0;
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, newZoomLevel));

            // If zoom is at minimum, reset to 'contain' to ensure it fits perfectly
            if (zoomLevel <= 1.01) {
                spinnerDiv.style.backgroundSize = 'contain';
                resetPan();
            } else {
                spinnerDiv.style.backgroundSize = `${zoomLevel * 100}%`;
                // Re-clamp pan values after zoom to prevent getting stuck at an edge
                const minPan = 50 / zoomLevel;
                const maxPan = 100 - minPan;
                panX = Math.max(minPan, Math.min(maxPan, panX));
                panY = Math.max(minPan, Math.min(maxPan, panY));
                spinnerDiv.style.backgroundPosition = `${panX}% ${panY}%`;
            }
        }

        function resetPan() {
            panX = 50; panY = 50;
            spinnerDiv.style.backgroundPosition = 'center';
        }
        
        function resetZoomAndPan() {
            zoomLevel = 1.0;
            spinnerDiv.style.backgroundSize = 'contain';
            resetPan();
        }

        function onDragStart(clientX, clientY) {
            isDragging = true;
            lastX = clientX; lastY = clientY;
            spinnerContainer.style.cursor = (zoomLevel > 1) ? 'move' : 'grabbing';
        }

        function onDragMove(clientX, clientY) {
            if (!isDragging) return;
            if (zoomLevel > 1.01) { panImage(clientX, clientY); } 
            else { updateImage(clientX); }
        }

        function onDragEnd() {
            isDragging = false;
            spinnerContainer.style.cursor = 'grab';
        }

        function getPinchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // --- Event Listeners ---
        document.getElementById('back-button').addEventListener('click', showList);
        searchBar.addEventListener('keyup', filterSpecimens);
        
        spinnerContainer.addEventListener('wheel', e => {
            e.preventDefault();
            updateZoom(zoomLevel - e.deltaY * 0.01);
        }, { passive: false });
        
        spinnerContainer.addEventListener('mousedown', e => onDragStart(e.clientX, e.clientY));
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('mousemove', e => onDragMove(e.clientX, e.clientY));
        
        spinnerContainer.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                onDragStart(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                isDragging = false; // Stop single-touch drag when pinch starts
                initialPinchDistance = getPinchDistance(e.touches);
                initialZoomLevel = zoomLevel;
            }
        }, { passive: false }); // `passive: false` is crucial to allow preventDefault

        window.addEventListener('touchend', e => {
            if (e.touches.length < 2) onDragEnd();
        });

        spinnerContainer.addEventListener('touchmove', e => {
            // Prevent browser default actions like scrolling ONLY on the viewer
            e.preventDefault(); 
            
            if (e.touches.length === 1 && isDragging) {
                onDragMove(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                const newPinchDistance = getPinchDistance(e.touches);
                if (initialPinchDistance > 0) {
                    const pinchRatio = newPinchDistance / initialPinchDistance;
                    updateZoom(initialZoomLevel * pinchRatio);
                }
            }
        }, { passive: false });
        
        loadSpecimenList();
    </script>
</body>
</html>


