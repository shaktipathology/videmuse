<!-- index.html - Your Public Frontend -->
<!-- Upload this file to your GitHub repository. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Digital Museum of Pathology Specimens</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --header-color: #2c3e50;
            --subheader-color: #7f8c8d;
            --border-color: #ddd;
            --hover-bg-color: #ecf0f1;
            --button-bg-color: #7f8c8d;
            --button-border-color: #7f8c8d;
        }

        body.dark-theme {
            --bg-color: #000000;
            --card-bg-color: #1c1c1e;
            --text-color: #ffffff;
            --header-color: #ffffff;
            --subheader-color: #a0a0a0;
            --border-color: #333333;
            --hover-bg-color: #3a3a3a;
            --button-bg-color: #333;
            --button-border-color: #555;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 10px; 
            box-sizing: border-box; 
            transition: background-color 0.3s, color 0.3s;
        }
        
        #theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1002;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
        }
        .sun-icon { display: none; }
        body.dark-theme .sun-icon { display: block; }
        body.dark-theme .moon-icon { display: none; }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2em; color: var(--header-color); margin-bottom: 5px; }
        .header p { font-size: 1.1em; color: var(--subheader-color); margin-top: 0; }
        .main-container { width: 100%; max-width: 900px; margin: 10px auto; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 15px; box-sizing: border-box; }
        #specimen-list-container { text-align: left; }
        #specimen-viewer-container { display: none; }
        #search-bar { width: 100%; padding: 12px; font-size: 1em; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        .organ-system-category h2 { color: var(--header-color); border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 30px; }
        .specimen-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .specimen-item { padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .specimen-item:hover { background-color: var(--hover-bg-color); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #spinner-container { position: relative; width: 100%; margin: 20px auto; user-select: none; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); touch-action: pan-y; cursor: grab; }
        #spinner-image-div { width: 100%; aspect-ratio: 3 / 4; background-repeat: no-repeat; background-position: center; background-size: 100%; transition: background-size 0.2s ease-out; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; font-size: 1.2em; color: #333; z-index: 10; display: none; }
        body.dark-theme #loading-overlay { background: rgba(0, 0, 0, 0.8); color: #f1f1f1; }
        #back-button { margin-bottom: 20px; background: var(--button-bg-color); border: 1px solid var(--button-border-color); color: white; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        .notes-section { text-align: left; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .notes-section h3 { color: var(--header-color); }
        .notes-section p, .notes-section ul { font-size: 1em; line-height: 1.6; color: var(--text-color); }
        #viewer-info-panel { display: none; }

        /* Edge-to-edge viewer styles */
        body.viewer-active { overflow: hidden; }
        body.viewer-active #specimen-viewer-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; background: var(--bg-color); z-index: 1000; padding: 0; border-radius: 0; display: flex; flex-direction: column;
        }
        body.viewer-active #spinner-container { flex-shrink: 0; width: 100%; height: 70vh; border: none; border-radius: 0; margin: 0; }
        body.viewer-active #spinner-image-div { width: 100%; height: 100%; aspect-ratio: unset; background-size: contain; }
        body.viewer-active #back-button { position: absolute; top: 20px; left: 20px; z-index: 1001; }
        body.viewer-active header, body.viewer-active .notes-section { display: none; }
        body.viewer-active #viewer-info-panel { display: block; flex-grow: 1; overflow-y: auto; padding: 20px; text-align: left; }
        #viewer-info-title { margin: 0 0 10px 0; font-size: 1.5em; color: var(--header-color); }
        #viewer-info-description { margin: 0; font-size: 1em; line-height: 1.6; color: var(--text-color); }

    </style>
</head>
<body>

    <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24"><path d="M12 9c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm0 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm8-4h-2.07c-.33-1.2-.86-2.32-1.57-3.3l1.45-1.45c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.45 1.45C14.32 3.86 13.2 3.33 12 3.07V1c0-.55-.45-1-1-1s-1 .45-1 1v2.07c-1.2.33-2.32.86-3.3 1.57l-1.45-1.45c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.45 1.45c-.71.98-1.24 2.1-1.57 3.3H1c-.55 0-1 .45-1 1s.45 1 1 1h2.07c.33 1.2.86 2.32 1.57 3.3l-1.45 1.45c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.45-1.45c.98.71 2.1 1.24 3.3 1.57V23c0 .55.45 1 1 1s1-.45 1-1v-2.07c1.2-.33 2.32-.86 3.3-1.57l1.45 1.45c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.45-1.45c.71-.98 1.24-2.1 1.57-3.3H23c.55 0 1-.45 1-1s-.45-1-1-1zm-8 8c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-2.27-1.5-3.82-3.96-3.82-6.81 0-2.64 1.39-4.96 3.48-6.33-.31-.03-.62-.05-.94-.05z"/></svg>
    </button>

    <div id="specimen-list-container">
        <header class="header">
            <h1>Digital Museum of Pathology Specimens</h1>
            <p>An interactive archive for medical education.</p>
        </header>
        <div class="main-container">
            <input type="text" id="search-bar" placeholder="Search by title, description, or keyword...">
            <div id="specimen-list">
                <p>Loading specimens...</p>
            </div>
        </div>
    </div>

    <div id="specimen-viewer-container" class="main-container">
        <button id="back-button">&larr; Back to Archive</button>
        <div id="spinner-container">
            <div id="spinner-image-div" role="img" aria-label="360 specimen view"></div>
            <div id="loading-overlay">Loading...</div>
        </div>
        <div id="viewer-info-panel">
            <h2 id="viewer-info-title"></h2>
            <p id="viewer-info-description"></p>
        </div>
        <!-- This section is now hidden in viewer mode by CSS -->
        <section class="notes-section">
             <h1 id="viewer-title"></h1>
            <div id="viewer-notes"></div>
        </section>
    </div>

    <!-- Hidden container for preloading images into the DOM -->
    <div id="preload-container" style="display: none;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD3XmS2pl4mBZ8Ov3XjRg7kIi8VtcTwq7E",
            authDomain: "muse-4f192.firebaseapp.com",
            projectId: "muse-4f192",
            storageBucket: "muse-4f192.firebasestorage.app", // The DEFAULT bucket
            messagingSenderId: "587629353476",
            appId: "1:587629353476:web:08063709cc60e92ea57351",
            measurementId: "G-NMDD20TYVB"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const storage = firebase.storage(app, "gs://muse-4f192-asia");

        const listContainer = document.getElementById('specimen-list-container');
        const viewerContainer = document.getElementById('specimen-viewer-container');
        const specimenListDiv = document.getElementById('specimen-list');
        const spinnerDiv = document.getElementById('spinner-image-div');
        const spinnerContainer = document.getElementById('spinner-container');
        const searchBar = document.getElementById('search-bar');
        const loadingOverlay = document.getElementById('loading-overlay');
        const themeToggle = document.getElementById('theme-toggle');
        
        let allSpecimens = []; 
        let specimensData = {};
        let currentImageUrls = [];
        let currentFrame = 0;
        let isDragging = false;
        let lastX = 0, lastY = 0, panX = 50, panY = 50, zoomLevel = 1;
        let initialPinchDistance = 0, initialZoomLevel = 1;

        // --- Theme Toggler ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);


        async function loadSpecimenList() {
            try {
                const snapshot = await db.collection("specimens").orderBy("createdAt", "desc").get();
                allSpecimens = [];
                specimensData = {};
                if (snapshot.empty) {
                    renderSpecimens([]);
                    return;
                }
                snapshot.forEach(doc => {
                    const specimen = { id: doc.id, ...doc.data() };
                    allSpecimens.push(specimen);
                    specimensData[doc.id] = specimen;
                });
                renderSpecimens(allSpecimens);
            } catch (error) {
                console.error("Error loading specimens:", error);
                specimenListDiv.innerHTML = '<p>Error loading specimens. Please check your Firestore security rules.</p>';
            }
        }

        function renderSpecimens(specimensToRender) {
            specimenListDiv.innerHTML = '';
            if (specimensToRender.length === 0) {
                specimenListDiv.innerHTML = '<p>No matching specimens found.</p>';
                return;
            }

            const groupedBySystem = specimensToRender.reduce((acc, specimen) => {
                const system = specimen.organSystem || 'Other';
                if (!acc[system]) { acc[system] = []; }
                acc[system].push(specimen);
                return acc;
            }, {});

            const sortedSystems = Object.keys(groupedBySystem).sort();

            for (const system of sortedSystems) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'organ-system-category';
                categoryDiv.innerHTML = `<h2>${system}</h2>`;
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'specimen-grid';

                groupedBySystem[system].forEach(specimen => {
                    const item = document.createElement('div');
                    item.className = 'specimen-item';
                    item.textContent = specimen.title;
                    item.onclick = () => showViewer(specimen.id);
                    gridDiv.appendChild(item);
                });
                
                categoryDiv.appendChild(gridDiv);
                specimenListDiv.appendChild(categoryDiv);
            }
        }
        
        function filterSpecimens() {
            const query = searchBar.value.toLowerCase();
            const filtered = allSpecimens.filter(s => 
                s.title.toLowerCase().includes(query) ||
                s.description.toLowerCase().includes(query) ||
                s.keywords.some(k => k.toLowerCase().includes(query))
            );
            renderSpecimens(filtered);
        }

        async function showViewer(specimenId) {
            const specimen = specimensData[specimenId];
            if (!specimen) return;

            document.getElementById('viewer-title').textContent = specimen.title;
            const notesDiv = document.getElementById('viewer-notes');
            notesDiv.innerHTML = `
                <h3>Description</h3>
                <p>${specimen.description.replace(/\n/g, '<br>')}</p>
                <h3>Keywords</h3>
                <p><em>${specimen.keywords.join(', ')}</em></p>
            `;
            
            document.getElementById('viewer-info-title').textContent = specimen.title;
            document.getElementById('viewer-info-description').textContent = specimen.description;

            currentImageUrls = specimen.imageUrls;
            
            document.body.classList.add('viewer-active');
            viewerContainer.style.display = 'flex';

            if (currentImageUrls.length > 0) {
                loadingOverlay.style.display = 'flex';
                await preloadImages(currentImageUrls);
                loadingOverlay.style.display = 'none';
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[0]})`;
            }
        }

        function showList() {
            document.body.classList.remove('viewer-active');
            viewerContainer.style.display = 'none';
            resetZoomAndPan();
        }

        function preloadImages(urls) {
            const preloadContainer = document.getElementById('preload-container');
            preloadContainer.innerHTML = '';
            const promises = urls.map(src => {
                return new Promise((resolve, reject) => {
                    const img = document.createElement('img');
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = src;
                    preloadContainer.appendChild(img);
                });
            });
            return Promise.all(promises);
        }

        function updateImage(newX) {
            const sensitivity = 10;
            if (Math.abs(newX - lastX) > sensitivity) {
                currentFrame += (newX > lastX) ? 1 : -1;
                if (currentFrame >= currentImageUrls.length) currentFrame = 0;
                if (currentFrame < 0) currentFrame = currentImageUrls.length - 1;
                spinnerDiv.style.backgroundImage = `url(${currentImageUrls[currentFrame]})`;
                lastX = newX;
            }
        }
        
        function panImage(clientX, clientY) {
            const rect = spinnerContainer.getBoundingClientRect();
            const newPanX = panX + (clientX - lastX) / rect.width * 100;
            const newPanY = panY + (clientY - lastY) / rect.height * 100;
            const maxPan = 100 - (50 / (zoomLevel / 2));
            const minPan = 100 - maxPan;
            panX = Math.max(minPan, Math.min(maxPan, newPanX));
            panY = Math.max(minPan, Math.min(maxPan, newPanY));
            spinnerDiv.style.backgroundPosition = `${panX}% ${panY}%`;
            lastX = clientX;
            lastY = clientY;
        }

        function updateZoom(newZoomLevel) {
            const minZoom = 1.0, maxZoom = 4.0;
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, newZoomLevel));
            spinnerDiv.style.backgroundSize = `${zoomLevel * 100}%`;
            if (zoomLevel <= 1) resetPan();
        }

        function resetPan() {
            panX = 50; panY = 50;
            spinnerDiv.style.backgroundPosition = 'center';
        }
        
        function resetZoomAndPan() {
            zoomLevel = 1.0;
            spinnerDiv.style.backgroundSize = '100%';
            resetPan();
        }

        function onDragStart(clientX, clientY) {
            isDragging = true;
            lastX = clientX; lastY = clientY;
            spinnerContainer.style.cursor = (zoomLevel > 1) ? 'move' : 'grabbing';
        }
        function onDragMove(clientX, clientY) {
            if (!isDragging) return;
            if (zoomLevel > 1) { panImage(clientX, clientY); } 
            else { updateImage(clientX); }
        }
        function onDragEnd() {
            isDragging = false;
            spinnerContainer.style.cursor = 'grab';
        }

        function getPinchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        document.getElementById('back-button').addEventListener('click', showList);
        searchBar.addEventListener('keyup', filterSpecimens);
        
        spinnerContainer.addEventListener('wheel', e => {
            e.preventDefault();
            updateZoom(zoomLevel - e.deltaY * 0.01);
        });
        
        spinnerContainer.addEventListener('mousedown', e => onDragStart(e.clientX, e.clientY));
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('mousemove', e => onDragMove(e.clientX, e.clientY));
        
        spinnerContainer.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                onDragStart(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                initialPinchDistance = getPinchDistance(e.touches);
                initialZoomLevel = zoomLevel;
            }
        }, { passive: true });

        window.addEventListener('touchend', e => {
            if (e.touches.length < 2) {
                onDragEnd();
            }
        });

        window.addEventListener('touchmove', e => {
            if (e.touches.length === 1) {
                onDragMove(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                const newPinchDistance = getPinchDistance(e.touches);
                if (initialPinchDistance > 0) {
                    const pinchRatio = newPinchDistance / initialPinchDistance;
                    updateZoom(initialZoomLevel * pinchRatio);
                }
            }
        });
        
        document.addEventListener('gesturestart', e => e.preventDefault());
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) { e.preventDefault(); }
            lastTouchEnd = now;
        }, false);

        loadSpecimenList();
    </script>
</body>
</html>
